---
layout: post
title:  "智能终端激活、结算环节问题讨论方案整理"
date:   2017-05-08
categories: note
tags: issues
excerpt: 现有激活流程复杂，结算会出现不准确，故通过会议整理了一些优化点。
author: ChenFeng
---

### 一、背景

现有激活流程复杂，结算会出现不准确。具体表现在以下方面。

##### 1、激活

* 风狐 APP 为了兼容以前，存在两种激活方式（ SN 号和 激活码），服务平台出现两种混乱，导致激活不成功或者参数下载、账单等一些列问题。
* 友盟推送的 deviceToken 获取失败导致激活不能进行。
* SDK 存在激活流程，导致接入者难度加大，迅联投入的支持成本增加。

##### 2、结算

* 后台数据库偶发 BUG 导致数据不准确（如上次的磁盘已满、同步失败等）。
* 服务平台接口数据问题导致账单不准确（如日期比较错误）。
* 风狐 APP 结算功能的代码 BUG 导致结算错误。

### 二、优化方案

##### 1、激活

* 针对风狐 APP ，服务平台优化终端入网流程，引导机构正确配置激活方式，便不会出现激活错误。
* 友盟 deviceToken 放在`更新`或者`账单`这两个高频接口上送，激活不再验 deviceToken。
* SDK 不做激活任务，放开让接入者管理自己的终端设备，服务平台一次性激活所有的终端，将迅联需要验证的数据发给接入者管理即可。

##### 2、结算

* 由于服务端的数据也不能保证一定准确，干脆直接使用智能终端的本地账单，当收银员发现有结算预览有误，再提供在线账单，并指出存在问题的交易。
* 结算只打印汇总信息，详情放入补打里面（属于之前没理解到业务，终端打印代码调整即可）。

##### 3、会议引申出来的优化问题

* 终端参数下载、密钥下载、AID下载、IC公钥下载合并成一个接口，统一称之为`参数下载`。并且提供一套默认参数在终端里，每次比较参数版本号即可。
* 服务平台提供批量操作功能，方便机构配置与邮寄终端（二维码、商户号终端号、门店名、门店地址等信息打包成信封和终端一同发到门店即可）

### 三、技术实现（概览）

|功能|数据中心|服务平台|智能终端|优先级|
|:--|:--|:--|:--|:--|
|入网优化|/|明确提示机构选择激活方式|/|高|
| deviceToken 验证|/|激活接口不验证|更新接口上送 deviceToken|高|
|SDK 不做激活|/|批量激活脚本，生成文档发送给接入者|删除激活功能|中|
|本地结算|提高数据稳定性|提高接口正确性|结算改造成本地结算，并且提供本地和在线对比功能|高|
|结算打印|/|/|结算时只打印汇总信息，补打提供打印详情功能|高|
|参数下载|/|将所有的参数包装在一个接口返回比，增加参数版本接口|初始化流程改造，提供默认参数，更新接口加入参数更新|中|
|机构批量操作|/|提供打印二维码、商户号终端号、门店名、门店地址等信息|/|底|

> 附：`/` 表示对应职能组不需要改动

